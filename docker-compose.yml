version: '3.8'

services:
  telegramploy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: telegramploy
    restart: unless-stopped

    # Environment variables (override in Dokploy)
    environment:
      # Database
      - DATABASE_PATH=/app/data/telegramploy.db

      # S3 Configuration (RustFS)
      - S3_ENDPOINT=https://your-rustfs-endpoint.com
      - S3_REGION=us-east-1
      - S3_ACCESS_KEY_ID=your-access-key
      - S3_SECRET_ACCESS_KEY=your-secret-key
      - S3_FORCE_PATH_STYLE=true

      # Telegram Bot
      - TELEGRAM_BOT_TOKEN=your-bot-token
      - TELEGRAM_CHAT_ID=your-chat-id

      # Next-Auth
      - NEXTAUTH_URL=https://telegramploy.dok.v244.net
      - NEXTAUTH_SECRET=your-generated-secret

      # Polling Configuration
      - POLL_INTERVAL_MS=60000
      - MAX_FILE_SIZE_MB=2000
      - CHUNK_SIZE_MB=50

      # Node Environment
      - NODE_ENV=production

    # Persistent volume for SQLite database
    volumes:
      - telegramploy-data:/app/data

    # Expose port 3000
    ports:
      - "3000:3000"

    # Health check
    healthcheck:
      test: ["CMD", "bun", "run", "-e", "fetch('http://localhost:3000/api/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

volumes:
  telegramploy-data:
    driver: local
